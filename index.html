<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Octalysis 八角框架分析工具</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #f8fafc;
            font-family: "Microsoft JhengHei", sans-serif;
        }
        .canvas-container {
            position: relative;
            margin: auto;
            height: 60vh;
            width: 100%;
        }
        /* 移除數字輸入框的箭頭 */
        input[type="number"] {
            -moz-appearance: textfield;
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">
        <!-- 標題區 -->
        <div class="bg-slate-800 text-white p-6 text-center">
            <h1 class="text-3xl font-bold mb-2">現況診斷 (Octalysis Analysis)</h1>
            <p class="text-slate-400">針對產品/情境，分析 CD1~CD8 的動機元素與驅動力</p>
        </div>

        <div class="flex flex-col lg:flex-row">
            <!-- 左側：圖表主視覺 -->
            <div class="relative lg:w-3/4 p-6 flex flex-col items-center justify-center border-b lg:border-b-0 lg:border-r border-slate-200"
                style="
                    background:
                        linear-gradient(#e5e7eb 4px, transparent 0),
                        linear-gradient(90deg, #e5e7eb 4px, transparent 0),
                        linear-gradient(transparent 50%, #c5cede 0);
                    background-size: 100% 52.25%, 50% 100%, 100% 105%;">
                <span class="font-bold text-[11px] text-slate-500">白帽：帶來希望與掌控感，適合長期體驗（如社群、忠誠計畫）</span>
                <div class="canvas-container">
                    <canvas id="octalysisChart"></canvas>
                </div>
                <span class="font-bold text-[11px] text-slate-500">黑帽：製造焦慮與急迫感，短期強烈但長期可能負面（如限時提示）</span>
                <span class="absolute font-bold left-4 text-[11px] text-slate-500">左腦（外在動機）：<br>行為來自獎勵或目標<br>一旦獎勵消失<br>行為也會停止</span>
                <span class="absolute font-bold right-4 text-[11px] text-slate-500">右腦（內在動機）：<br>行為來自樂趣與情感<br>即使沒有獎勵<br>也會投入</span>
            </div>

            <!-- 右側：控制面板 -->
            <div class="lg:w-1/4 p-6 bg-slate-50 overflow-y-auto" style="height: calc(100dvh - 11.5rem);">
                <h2 class="text-xl font-bold mb-4 text-slate-700 border-b pb-2">數據設定</h2>
                
                <!-- 目前狀態 (固定) -->
                <div class="mb-6">
                    <h3 class="font-bold text-blue-600 mb-3 flex items-center">
                        <span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span> 目前現況
                    </h3>
                    <div id="currentInputs" class="grid grid-cols-2 gap-3">
                        <!-- 動態生成 CD1-CD8 輸入框 -->
                    </div>
                </div>

                <!-- 預計目標 (切換) -->
                <div class="mb-6 border-t pt-4">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-emerald-600 flex items-center">
                            <span class="w-3 h-3 bg-emerald-500 rounded-full mr-2"></span> 預計目標
                        </h3>
                        <button onclick="toggleDataset('target')" id="btn-target" class="text-xs px-2 py-1 rounded bg-emerald-100 text-emerald-700 hover:bg-emerald-200 transition">顯示/隱藏</button>
                    </div>
                    <div id="targetInputs" class="grid grid-cols-2 gap-3 hidden">
                        <!-- 目標分數輸入 -->
                    </div>
                </div>

                <!-- 競品分析 -->
                <div class="mb-6 border-t pt-4">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-orange-600 flex items-center">
                            <span class="w-3 h-3 bg-orange-500 rounded-full mr-2"></span> 競品對比
                        </h3>
                        <button onclick="addCompetitor()" class="text-xs px-2 py-1 rounded bg-orange-100 text-orange-700 hover:bg-orange-200 transition">+ 新增競品</button>
                    </div>
                    <div id="competitorList" class="space-y-4">
                        <!-- 競品列表區域 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 1. 定義圖表上的標籤順序 (維持您原本的設定，這決定了雷達圖軸線的順序)
        // 順序: CD1, CD3, CD5, CD7, CD8, CD6, CD4, CD2 (對應 index 0~7)
        const chartLabels = [
            'CD1 重大使命',
            'CD3 賦予創造',
            'CD5 社交影響',
            'CD7 未知好奇',
            'CD8 損失避免',
            'CD6 稀缺迫切',
            'CD4 所有權',
            'CD2 發展成就'
        ];

        // 2. 定義輸入框的順序與對應關係 (這是給使用者看的，依照 CD1~CD8 排序)
        // dataIndex 指向 chartLabels 陣列中的位置
        const inputConfig = [
            { code: 'CD1', label: '重大使命與呼召', dataIndex: 0 },
            { code: 'CD2', label: '發展與成就', dataIndex: 7 }, // 在 chartLabels 的最後一個
            { code: 'CD3', label: '賦予創造力與回饋', dataIndex: 1 },
            { code: 'CD4', label: '所有權與佔有欲',   dataIndex: 6 },
            { code: 'CD5', label: '社交影響力與同理心', dataIndex: 2 },
            { code: 'CD6', label: '稀缺性與迫切', dataIndex: 5 },
            { code: 'CD7', label: '不確定性與好奇心', dataIndex: 3 },
            { code: 'CD8', label: '損失與避免', dataIndex: 4 }
        ];

        let chart;
        const datasets = {
            current: [5, 4, 6, 3, 5, 2, 4, 3], // 這裡的數據順序對應 chartLabels
            target: [8, 8, 7, 6, 7, 5, 6, 4],
            competitors: [] 
        };

        const colors = [
            'rgba(249, 115, 22, 0.7)', // Orange
            'rgba(168, 85, 247, 0.7)', // Purple
            'rgba(236, 72, 153, 0.7)', // Pink
            'rgba(20, 184, 166, 0.7)'  // Teal
        ];

        function initChart() {
            const ctx = document.getElementById('octalysisChart').getContext('2d');
            
            const chartData = {
                labels: chartLabels,
                datasets: [
                    {
                        label: '目前現況',
                        data: datasets.current,
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: 'rgb(59, 130, 246)',
                        pointBackgroundColor: 'rgb(59, 130, 246)',
                        borderWidth: 3,
                        fill: true
                    },
                    {
                        label: '預計目標',
                        data: datasets.target,
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderColor: 'rgb(16, 185, 129)',
                        pointBackgroundColor: 'rgb(16, 185, 129)',
                        borderDash: [5, 5],
                        borderWidth: 2,
                        hidden: true,
                        fill: true
                    }
                ]
            };

            chart = new Chart(ctx, {
                type: 'radar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { color: '#e2e8f0' },
                            grid: { color: '#e2e8f0' },
                            suggestedMin: 0,
                            suggestedMax: 10,
                            ticks: { stepSize: 2, display: false },
                            pointLabels: {
                                font: { size: 14, weight: 'bold' },
                                color: '#475569'
                            }
                        }
                    },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    // Tooltip 顯示完整的標籤
                                    return context[0].label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 修改後的生成輸入框函數：使用 inputConfig 進行順序生成
        function createInputGroup(containerId, dataArray, type, competitorIndex = null) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            // 遍歷 inputConfig (CD1 到 CD8 順序)
            inputConfig.forEach((item) => {
                const div = document.createElement('div');
                div.className = 'flex flex-col relative group';
                
                const labelText = document.createElement('label');
                labelText.className = 'text-[11px] font-bold text-slate-500 mb-1';
                labelText.innerText = `${item.code} ${item.label}`;
                
                const input = document.createElement('input');
                input.type = 'number';
                input.min = 0;
                input.max = 10;
                // 根據 mapping 取得正確的數據值
                // dataIndex 是該項目在 chart labels/data array 中的真實位置
                input.value = competitorIndex !== null ? datasets.competitors[competitorIndex].data[item.dataIndex] : dataArray[item.dataIndex];
                
                // 設定輸入框顏色樣式
                let ringColor = 'focus:ring-blue-400';
                if(type === 'target') ringColor = 'focus:ring-emerald-400';
                if(type === 'competitor') ringColor = 'focus:ring-orange-400';

                input.className = `border border-slate-300 rounded px-2 py-1 text-sm focus:ring-2 ${ringColor} outline-none transition shadow-sm`;
                
                input.oninput = (e) => {
                    let val = parseInt(e.target.value) || 0;
                    if (val > 10) val = 10;
                    if (val < 0) val = 0;
                    
                    // 更新數據時，寫入到正確的 dataIndex 位置
                    if (competitorIndex !== null) {
                        datasets.competitors[competitorIndex].data[item.dataIndex] = val;
                        updateChart();
                    } else if (type === 'current') {
                        datasets.current[item.dataIndex] = val;
                        chart.data.datasets[0].data = datasets.current;
                        chart.update();
                    } else if (type === 'target') {
                        datasets.target[item.dataIndex] = val;
                        chart.data.datasets[1].data = datasets.target;
                        chart.update();
                    }
                };

                div.appendChild(labelText);
                div.appendChild(input);
                container.appendChild(div);
            });
        }

        function toggleDataset(type) {
            const isTarget = type === 'target';
            const btn = document.getElementById(`btn-${type}`);
            const inputArea = document.getElementById(`${type}Inputs`);
            
            const datasetIndex = isTarget ? 1 : null;
            
            // 切換圖表顯示
            const meta = chart.getDatasetMeta(datasetIndex);
            meta.hidden = meta.hidden === null ? !chart.data.datasets[datasetIndex].hidden : null;
            chart.setDatasetVisibility(datasetIndex, !chart.isDatasetVisible(datasetIndex));
            
            chart.update();
            
            // 切換 UI 顯示
            inputArea.classList.toggle('hidden');
            btn.innerText = inputArea.classList.contains('hidden') ? '顯示/隱藏' : '收合';
            
            // 如果展開，重新生成輸入框以確保數值同步（非必要但安全）
            if(!inputArea.classList.contains('hidden')){
                createInputGroup('targetInputs', datasets.target, 'target');
            }
        }

        function addCompetitor() {
            const id = Date.now();
            const color = colors[datasets.competitors.length % colors.length];
            const newComp = {
                id: id,
                name: `競品 ${datasets.competitors.length + 1}`,
                // 預設值全為 3，依照 chartLabels 的順序
                data: [3, 3, 3, 3, 3, 3, 3, 3],
                color: color
            };
            datasets.competitors.push(newComp);
            renderCompetitorList();
            updateChart();
        }

        function removeCompetitor(id) {
            datasets.competitors = datasets.competitors.filter(c => c.id !== id);
            renderCompetitorList();
            updateChart();
        }

        function renderCompetitorList() {
            const container = document.getElementById('competitorList');
            container.innerHTML = '';

            datasets.competitors.forEach((comp, idx) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'bg-white p-4 rounded-lg border border-slate-200 shadow-sm transition hover:shadow-md';
                
                const header = document.createElement('div');
                header.className = 'flex justify-between items-center mb-3 pb-2 border-b border-dashed border-slate-200';
                
                const nameWrapper = document.createElement('div');
                nameWrapper.className = 'flex items-center gap-2 w-full';
                
                // 色塊標示
                const colorDot = document.createElement('div');
                colorDot.className = 'w-3 h-3 rounded-full';
                colorDot.style.backgroundColor = comp.color;

                const nameInput = document.createElement('input');
                nameInput.value = comp.name;
                nameInput.className = 'font-bold text-sm bg-transparent border-none focus:ring-0 text-slate-700 w-2/3';
                nameInput.oninput = (e) => {
                    comp.name = e.target.value;
                    updateChart();
                };

                const delBtn = document.createElement('button');
                delBtn.innerHTML = '✕ 移除';
                delBtn.className = 'text-slate-400 hover:text-red-500 text-xs ml-auto whitespace-nowrap px-2';
                delBtn.onclick = () => removeCompetitor(comp.id);

                nameWrapper.appendChild(colorDot);
                nameWrapper.appendChild(nameInput);
                nameWrapper.appendChild(delBtn);
                header.appendChild(nameWrapper);
                wrapper.appendChild(header);

                const gridId = `comp-grid-${comp.id}`;
                const grid = document.createElement('div');
                grid.id = gridId;
                // 競品輸入框稍微小一點，一行4個
                grid.className = 'grid grid-cols-4 gap-x-2 gap-y-3';
                wrapper.appendChild(grid);
                
                container.appendChild(wrapper);
                
                // 使用修改後的函數生成輸入框 (會自動依照 CD1-CD8 排序)
                createInputGroup(gridId, null, 'competitor', idx);
            });
        }

        function updateChart() {
            // 保留前兩個基礎 Dataset (目前與預計)
            const baseDatasets = chart.data.datasets.slice(0, 2);
            
            // 重新加上競品 Dataset
            const compDatasets = datasets.competitors.map(comp => ({
                label: comp.name,
                data: comp.data,
                backgroundColor: comp.color.replace('0.7', '0.1'),
                borderColor: comp.color,
                pointBackgroundColor: comp.color,
                borderWidth: 2,
                fill: true
            }));

            chart.data.datasets = [...baseDatasets, ...compDatasets];
            chart.update();
        }

        window.onload = () => {
            initChart();
            createInputGroup('currentInputs', datasets.current, 'current');
            createInputGroup('targetInputs', datasets.target, 'target');
        };
    </script>
</body>
</html>
